name: licenses

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect-licenses:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend deps
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Generate npm license metadata
        working-directory: frontend
        run: |
          npx --yes license-checker-rseidelsohn \
            --production \
            --relativeLicensePath \
            --json > ../node_licenses.json

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.x'

      - name: Download Go modules
        run: go mod download

      - name: Install go-licenses
        run: go install github.com/google/go-licenses/v2@latest

      - name: Save Go licenses
        run: |
          mkdir -p licenses_go
          go-licenses save ./... \
            --save_path=licenses_go \
            --force \
            --ignore "$(go list -m)"

      - name: Report Go licenses to CSV
        run: |
          go-licenses report ./... \
            --ignore "$(go list -m)" > go_licenses.csv

      - name: Save Go licenses
        run: |
          mkdir -p licenses_go
          go-licenses save ./... --save_path=licenses_go --force --ignore $(go list -m)

      - name: Report Go licenses to CSV
        run: go-licenses report --ignore $(go list -m) ./... > go_licenses.csv


      - name: Merge license data
        run: node scripts/license.js

      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "chore(licenses): refresh merged license list [skip ci]"
          file_pattern: frontend/src/assets/licenses.json
          branch: ${{ github.ref_name }}

