name: Nightly

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  nightly:
    runs-on: ubuntu-latest
    env:
      APP_NAME: whisper-notes
      PLATFORMS: windows/amd64,linux/amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install Linux deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Set up Git user
        uses: fregante/setup-git-user@v2

      - name: Move/refresh "nightly" tag
        run: |
          git tag -fa nightly -m "Nightly $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push -f origin nightly

      - name: Build Windows
        run: |
          wails build -platform "windows/amd64" -o "$APP_NAME-windows-amd64.exe" -tags "webkit2_41"

      - name: Build Linux
        run: |
          wails build -platform "linux/amd64" -o "$APP_NAME-linux-amd64" -tags "webkit2_41"

      - name: Update "Nightly" release 
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          target_commitish: ${{ github.sha }}
          name: Nightly
          prerelease: true
          make_latest: true
          files: |
            build/bin/${{ env.APP_NAME }}-windows-amd64.exe
            build/bin/${{ env.APP_NAME }}-linux-amd64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
